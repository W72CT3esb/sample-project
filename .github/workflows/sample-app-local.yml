name: Test CI/CD
on: 
  push:
   branches:
    - main
jobs:
  build:
    name: build-job
    runs-on: self-hosted
    steps:
    - name: checkout
      uses: actions/checkout@v3

    - name: build
      shell: cmd
      run: |
        set PATH=C:\Program Files (x86)\MSBuild\14.0\Bin;%PATH%
        rmdir /s /q sample-app\x64\Release
        MSBuild sample-app\sample-app.sln /t:rebuild /p:Configuration=Release;Platform=x64
        xcopy sample-app\sample-app\config.ini sample-app\x64\Release

  unittest:
    name: unittest-job
    needs: build
    runs-on: self-hosted
    steps:
    - name: unittest
      shell: cmd
      run: |
        set PATH=C:\3rdparty\opencv\build\x64\vc15\bin;%PATH%
        cd sample-app\x64\Release
        .\unittest.exe

  integrationtest:
    name: integrationtest-job
    needs: unittest
    runs-on: self-hosted
    steps:
    - name: integration-test
      shell: cmd
      run: | 
        set PATH=C:\3rdparty\opencv\build\x64\vc15\bin;%PATH%
        cd sample-app\x64\Release
        .\integrationtest.exe
        "C:\Program Files\WinMerge\WinMergeU.exe" C:\\Users\\NES\\Desktop\\hayakawa\\CICD\\Output_original\\result.csv C:\\Users\\NES\\Desktop\\hayakawa\\CICD\\Output\\result.csv /minimize /noninteractive /u /or .\out.html
        cd ..\..\ 
        rmdir /s /q path\to\artifacts
        mkdir path\to\artifacts
        xcopy sample-app\x64\Release path\to\artifacts

    - uses: actions/upload-artifacts
      with:
        name: my-artifact
        path: path/to/artifacts
        
  #   - name: copy
  #     shell: cmd
  #     run: |
  #       rmdir /s /q path\to\artifacts
  #       mkdir path\to\artifacts
  #       xcopy sample-app\x64\Release path\to\artifacts
  #   - uses: actions/upload-artifact@v3
  #     with: 
  #       name: my-artifact
  #       path: path/to/artifacts

  # deploy:
  #   name: deploy-job
  #   needs: test
  #   runs-on: self-hosted
  #   steps:
  #   - uses: actions/download-artifact@v3
  #     name: deploy
  #     with:
  #       name: my-artifact
  #       path: C:\Users\NES\Desktop\deploy
