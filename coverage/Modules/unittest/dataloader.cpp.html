<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>dataloader.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#include &lt;opencv2/opencv.hpp&gt;
#include &lt;iostream&gt;
#include &lt;string&gt;
#include &lt;vector&gt;
#include &lt;shlwapi.h&gt;
#include "dataloader.h"
#include "common.h"

// RXgN^
DataLoader::DataLoader()
<span style = "background-color:#dfd">{</span>
	//std::cout &lt;&lt; "DataLoaderIuWFNg¶¬" &lt;&lt; std::endl;
<span style = "background-color:#dfd">	this-&gt;frame_num = 0;</span>
	this-&gt;frame_index = 0;
	this-&gt;img_h = 0;
<span style = "background-color:#dfd">	this-&gt;img_w = 0;
	this-&gt;fps = 0.0;
	this-&gt;input_movie_path = "";
	this-&gt;input_image_path = "";
	this-&gt;data_type = 0;
	this-&gt;file_open_flag = false;
	this-&gt;device_id = 0;
}</span>

// fXgN^
DataLoader::~DataLoader()
<span style = "background-color:#dfd">{</span>
	//std::cout &lt;&lt; "DataLoaderIuWFNgjü" &lt;&lt; std::endl;
<span style = "background-color:#dfd">}</span>

// t[Ôðæ¾·éÖ
int DataLoader::get_frame_index()
{
	return this-&gt;frame_index;
}

// ®æâæÌt[ðæ¾·éÖ
int DataLoader::get_frame_num()
{
	return this-&gt;frame_num;
}

// ú»Ö
int DataLoader::initialize(const Params &amp;params)
<span style = "background-color:#dfd">{
	this-&gt;data_type = params.data_type;
	if (this-&gt;data_type == 0) // üÍf[^ª®æÌê</span>
	{
<span style = "background-color:#dfd">		if (!PathFileExists(params.input_movie_path.c_str())) // pXÌêÉt@Cª¶ÝµÈ¢êÉ¸s</span>
		{
<span style = "background-color:#dfd">			return -1;</span>
		}
<span style = "background-color:#dfd">		if (PathIsDirectory(params.input_movie_path.c_str())) // t@CÅÍÈ­fBNgÌêÉ¸s</span>
		{
<span style = "background-color:#dfd">			return -2;</span>
		}
<span style = "background-color:#dfd">		this-&gt;input_movie_path = params.input_movie_path; // üÍ®æf[^ÌpXðÝè</span>
	}
<span style = "background-color:#dfd">	else if (this-&gt;data_type == 1) // üÍf[^ªæÌê</span>
	{
<span style = "background-color:#dfd">		if (!PathFileExists(params.input_image_path.c_str())) // pXÌêÉfBNgª¶ÝµÈ¢êÉ¸s</span>
		{
<span style = "background-color:#dfd">			return -3;</span>
		}
<span style = "background-color:#dfd">		if (!PathIsDirectory(params.input_image_path.c_str())) // fBNgÅÍÈ¢êÉ¸s</span>
		{
<span style = "background-color:#dfd">			return -4;</span>
		}
<span style = "background-color:#dfd">		this-&gt;input_image_path = params.input_image_path; // üÍæQª éfBNgÌpXðÝè</span>
	}
	else // üÍf[^ªJ©çÌfÌê
	{
<span style = "background-color:#dfd">		this-&gt;device_id = params.device_id;
		this-&gt;img_h = params.c_frame_height;
		this-&gt;img_w = params.c_frame_width;
		this-&gt;fps = params.c_fps;</span>
	}

<span style = "background-color:#dfd">	return 0;
}</span>

// t[îñÉÂ¢Ä\¦·éÖifobOpj
void DataLoader::print_info()
{
	std::cout &lt;&lt; "Ååt[" &lt;&lt; this-&gt;frame_num &lt;&lt; std::endl;
	std::cout &lt;&lt; "t[Ì³:" &lt;&lt; this-&gt;img_h &lt;&lt; std::endl;
	std::cout &lt;&lt; "t[Ì:" &lt;&lt; this-&gt;img_w &lt;&lt; std::endl;
	std::cout &lt;&lt; "t[Ìfps:" &lt;&lt; this-&gt;fps &lt;&lt; std::endl;
}

// üÍf[^ðI[v·éÖ
int DataLoader::open_data()	
<span style = "background-color:#dfd">{</span>
	int iret = -1;
<span style = "background-color:#dfd">	if(this-&gt;file_open_flag) // ÖðññÈãÍÀs³¹È¢(falseÌÉÀs)</span>
	{
<span style = "background-color:#dfd">		return -1;</span>
	}
<span style = "background-color:#dfd">	if (this-&gt;data_type == 0) // üÍf[^ª®æÌê</span>
	{
<span style = "background-color:#dfd">		this-&gt;cap.open(this-&gt;input_movie_path);
		if (!this-&gt;cap.isOpened()) // t@CªJ¯È¢êÉ¸s</span>
		{
			//std::cout &lt;&lt; "®æt@CªJ¯Ü¹ñ" &lt;&lt; std::endl;
<span style = "background-color:#dfd">			return -2;</span>
		}

<span style = "background-color:#dfd">		this-&gt;frame_num = (int)this-&gt;cap.get(cv::CAP_PROP_FRAME_COUNT);
		this-&gt;img_h = (int)this-&gt;cap.get(cv::CAP_PROP_FRAME_HEIGHT);
		this-&gt;img_w = (int)this-&gt;cap.get(cv::CAP_PROP_FRAME_WIDTH);
		this-&gt;fps = this-&gt;cap.get(cv::CAP_PROP_FPS);</span>
	}
<span style = "background-color:#dfd">	else if (this-&gt;data_type == 1) // üÍf[^ªæÌê</span>
	{
<span style = "background-color:#dfd">		iret = get_filelist(); // üÍæf[^ÌfBNg©ç·×ÄÌæt@CÌpXðæ¾
		if (this-&gt;file_names.size() == 0) // fBNgàÉæt@CªÈ©Á½êÉ¸s</span>
		{
<span style = "background-color:#dfd">			return -3;</span>
		}
<span style = "background-color:#dfd">		this-&gt;frame_num = (int)this-&gt;file_names.size();</span>
	}
<span style = "background-color:#dfd">	else // üÍf[^ªJ©çÌfÌê</span>
	{
<span style = "background-color:#dfd">		this-&gt;cap.open(this-&gt;device_id);
		if (!this-&gt;cap.isOpened()) // t@CªJ¯È¢êÉ¸s</span>
		{
			//std::cout &lt;&lt; "cameraðJ¯Ü¹ñ" &lt;&lt; std::endl;
<span style = "background-color:#dfd">			return -4;</span>
		}
<span style = "background-color:#dfd">		cap.set(cv::CAP_PROP_FRAME_WIDTH, this-&gt;img_w);
		cap.set(cv::CAP_PROP_FRAME_HEIGHT, this-&gt;img_h);
		cap.set(cv::CAP_PROP_FPS, this-&gt;fps);
		this-&gt;img_w = (int)this-&gt;cap.get(cv::CAP_PROP_FRAME_WIDTH);
		this-&gt;img_h = (int)this-&gt;cap.get(cv::CAP_PROP_FRAME_HEIGHT);
		this-&gt;fps = this-&gt;cap.get(cv::CAP_PROP_FPS);</span>
		//print_info();
	}
	this-&gt;file_open_flag = true; //ÖðêxÇñ¾çtOðtrueÉ·é

<span style = "background-color:#dfd">	return 0;
}</span>

// üÍf[^ª®æÌêÉt[²ÆÉæÆµÄÛ¶·éÖifobOpj
void DataLoader::save_frame(cv::Mat &amp;img)
{
	//æ¾µ½æðAÔæÅÛ¶
	std::ostringstream oss;
	oss &lt;&lt; std::setfill('0') &lt;&lt; std::setw(4) &lt;&lt; this-&gt;frame_index;
	//cv::imwrite("C:\\Users\\1134142029087\\Desktop\\data2\\pic_" + oss.str() + ".jpg", img);
}

// ®æðÇÝÞÖ
int DataLoader::load_mv(cv::Mat &amp;img)
<span style = "background-color:#dfd">{
	if (!this-&gt;file_open_flag) // ®æt@CªI[vµÄ¢È¢êÍloadµÈ¢</span>
	{
<span style = "background-color:#fdd">		return -1;</span>
	}
<span style = "background-color:#dfd">	this-&gt;cap &gt;&gt; img;
	if (img.empty()) // imgªó¾Á½ç</span>
	{
<span style = "background-color:#fdd">		return -2;</span>
	}
	//cv::resize(img, img, cv::Size(), 0.5, 0.5);
	//std::cout &lt;&lt; "frame: " &lt;&lt; this-&gt;frame_index &lt;&lt; std::endl;
	//save_frame(img);
<span style = "background-color:#dfd">	return 0;
}</span>

// æðÇÝÞÖ
int DataLoader::load_img(cv::Mat &amp;img)
<span style = "background-color:#fdd">{</span>
	//std::cout &lt;&lt; this-&gt;file_names[this-&gt;frame_index] &lt;&lt; std::endl;
<span style = "background-color:#fdd">	img = cv::imread(this-&gt;file_names[this-&gt;frame_index]);
	if (img.empty()) // imgªó¾Á½ç</span>
	{
<span style = "background-color:#fdd">		return -1;</span>
	}
	//cv::resize(img, img, cv::Size(), 0.5, 0.5);
	//std::cout &lt;&lt; "frame: " &lt;&lt; this-&gt;frame_index &lt;&lt; std::endl;
<span style = "background-color:#fdd">	return 0;
}</span>

// t[Ôât@CpXðÔ·Ö(ß)
//std::string DataLoader::get_frame_info()
//{
//	if (this-&gt;data_type == 0) // ®æÌÍt[ÔðÔ·
//	{
//		return std::to_string(get_frame_index() - 1);
//	}
//	else if (this-&gt;data_type == 1) // æÌÍt@CpXðÔ·
//	{
//		return this-&gt;file_names[this-&gt;frame_index - 1];
//	}
//	else // JfÌÍt[ÔðÔ·
//	{
//		return std::to_string(get_frame_index() - 1);
//	}
//}

// t[Ôât@CpXðÔ·Ö(ÅV)
std::string DataLoader::get_frame_info()
<span style = "background-color:#dfd">{
	return std::to_string(get_frame_index() - 1);
}</span>


// 1t[¸Âæèo·Ö
int DataLoader::grab_image(cv::Mat &amp;img)
{
	int iret = -1;
	if (this-&gt;data_type == 0) // üÍf[^ª®æÌê
	{
		iret = load_mv(img);
		if (iret != 0)
		{
			return -1;
		}
	}
	else if (this-&gt;data_type == 1) // üÍf[^ªæÌê
	{
		iret = load_img(img);
		if (iret != 0)
		{
			return -2;
		}
	}
	else // üÍf[^ªJ©çÌfÌê
	{
		iret = load_mv(img);
		if (iret != 0)
		{
			return -3;
		}
	}
	this-&gt;frame_index++; // 1t[æèoµ½çJEg

	return 0;
}

// üÍæf[^ÌfBNg©ç·×ÄÌæt@CÌpXðæ¾·éÖ
int DataLoader::get_filelist()
<span style = "background-color:#dfd">{</span>
	HANDLE hFind;
	WIN32_FIND_DATA win32fd;
<span style = "background-color:#dfd">	std::vector&lt;std::string&gt; file_names;</span>

<span style = "background-color:#dfd">	std::vector&lt;std::string&gt; extension = { "png" ,"jpg", "bmp"};</span>

<span style = "background-color:#dfd">	for (int i = 0; i &lt; extension.size(); i++)</span>
	{

<span style = "background-color:#dfd">		std::string search_name = this-&gt;input_image_path + "\\*." + extension[i];</span>

		// wèµ½t@C¼Éêv·ét@CâfBNgðõ(ßèlÍ¬÷Fõnh,¸sF-1(INVALID_HANDLE_VALUE))
<span style = "background-color:#dfd">		hFind = FindFirstFile(search_name.c_str(), &amp;win32fd);</span>

<span style = "background-color:#dfd">		if (hFind == INVALID_HANDLE_VALUE) // t@CõÉ¸sµ½ê(returnð·éÆAæt@Cªjpg¾¯ÌÈÇÉpngÆbmpÍ¶ÝµÈ¢½ßA­§I¹µÄµÜ¤)</span>
		{
<span style = "background-color:#dfd">			continue;</span>
		}
		do
		{
<span style = "background-color:#dfd">			this-&gt;file_names.push_back(this-&gt;input_image_path + "\\" + win32fd.cFileName);
		} while (FindNextFile(hFind, &amp;win32fd)); // FindFirstFile ÖÌÄÑoµÉæéõð±s(ßèlÍ¬÷F0ÈO,¸sF0)</span>

		// wè³ê½õnhðN[Y(ßèlÍ¬÷F0ÈO,¸sF0)
<span style = "background-color:#dfd">		FindClose(hFind);
	}
	return 0;
}</span></pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>